source("./FRS_tools/assign_percentile.R")
## Append 2015 MIS amounts
source("./FRS_tools/append_mis.R")
#make plots of household charactersitics
source("./FRS_tools/make_household_plots.R")
#compare charactersitics of JAM groups
source("./FRS_tools/compare_JAM_plots.R")
#compare charactersitics of all LIPR groups
source("./FRS_tools/compare_LIPR_plots.R")
source("./FRS_tools/compare_LIPR_plots_refine.R")
flag.shared.ownership <- function (data_table){
shared_thresh <- read.csv("./shared_ownership_13141415thresholds_1.csv", header = TRUE,
colClasses = c("double", "double", "double", "character"), stringsAsFactors = FALSE)
shared_thresh <- data.table(shared_thresh)
#return(shared_thresh)
shared_keycols = c("GVTREGN", "year")
shared_cols = c("GVTREGN", "shared", "shared_deposit", "year" )
setkeyv(data_table, shared_keycols)
setkeyv(shared_thresh, shared_keycols)
data_table <- merge(data_table , shared_thresh[ , .SD, .SDcols = shared_cols], by = shared_keycols, all.x = TRUE)
data_table[ , aff_shared_noincben := ifelse( hh_grossinc_noincben >= shared, 1, 0 )]
data_table[ , cant_shareddep := ifelse( (TOTCAPB3 < (shared_deposit - 1000)) & (ADDMON == 2 | behind_debts==1), 1, 0 )]
#flag for shared ownership situation
data_table[ , affanddep_shared := 0]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==1, 1 , 0)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==0, 2 , affanddep_shared)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==0 , 0 , affanddep_shared)]
return(data_table)
}
### Make flatfiles ####
survey_dir <- "S:/@Communications, Policy and Campaigns/Research/STATS & INFO/Statistics/Household Surveys/"
dt_1415 <- make.flatfile(survey_dir, "1415")
dt_1314 <- make.flatfile(survey_dir, "1314")
dt_1415[ , year := "1415"]
dt_1314[ , year := "1314"]
l <- list(dt_1314, dt_1415)
dt_1315 <- rbindlist(l, fill = TRUE)
rm(l)
dt_1315 <- calculate.logical.flags(dt_1315, "1315")
dt_1315 <- calculate.weights(dt_1315, 1)
dt_1315 <- tidy.tenure(dt_1315)
#Calculate equivalisation weights (according to HBAI spec)
dt_1315<- calculate.equivalise(dt_1315)
#calculate income, including equivalised
dt_1315 <- calculate.household.incomes(dt_1315, "FRS", TRUE)
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/calculate_household_incomes.R')
dt_1315 <- calculate.household.incomes(dt_1315, "FRS", TRUE)
dt_1315 <- flag.shared.ownership(dt_1315)
flag.shared.ownership <- function (data_table){
shared_thresh <- read.csv("./shared_ownership_13141415thresholds.csv", header = TRUE,
colClasses = c("double", "double", "double", "character"), stringsAsFactors = FALSE)
shared_thresh <- data.table(shared_thresh)
#return(shared_thresh)
shared_keycols = c("GVTREGN", "year")
shared_cols = c("GVTREGN", "shared", "shared_deposit", "year" )
setkeyv(data_table, shared_keycols)
setkeyv(shared_thresh, shared_keycols)
data_table <- merge(data_table , shared_thresh[ , .SD, .SDcols = shared_cols], by = shared_keycols, all.x = TRUE)
data_table[ , aff_shared_noincben := ifelse( hh_grossinc_noincben >= shared, 1, 0 )]
data_table[ , cant_shareddep := ifelse( (TOTCAPB3 < (shared_deposit - 1000)) & (ADDMON == 2 | behind_debts==1), 1, 0 )]
#flag for shared ownership situation
data_table[ , affanddep_shared := 0]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==1, 1 , 0)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==0, 2 , affanddep_shared)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==0 , 0 , affanddep_shared)]
return(data_table)
}
dt_1315 <- flag.shared.ownership(dt_1315)
dt_1315 <- tidy.regions(dt_1315, "1315")
dt_1315[ , not_1stbenu := ifelse(BENUNIT >1 , 1, 0)]
dt_1315[ , multiple_benu := ifelse( (sum(not_1stbenu) > 0), 1, 0 ), by = .(SERNUM, year) ]
dt1315_noshare <- dt_1315[ (has_lodger == 0 & HHSTAT == 1), ]
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
dt1315_noshare_1bu <- dt1315_noshare[ multiple_benu == 0, ]
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/append_mis.R')
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
dt1315_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < ahc_mis*52, 1, 0)]
t_1315[ , over20gross_allben := ifelse(((HBENINC - HHTXCRED )/(HHINC)) > 0.2, 1, 0)]
#more than 20% of household income-HB comes from non-HB benefits, modified RF definition
dt_1315[ , over20grossnohb_nohbben := ifelse(!is.na(hh_hbweekly),
(ifelse((HBENINC-hh_hbweekly - HHTXCRED)/(HHINC-hh_hbweekly) > 0.2, 1, 0)),
(ifelse((HBENINC- HHTXCRED)/(HHINC) > 0.2, 1, 0)))]
dt1315_noshare <- dt_1315[ (has_lodger == 0 & HHSTAT == 1), ]
#select households with only 1 benefit unit - necessary for current shared ownership/MIS definitions of low income
dt1315_noshare_1bu <- dt1315_noshare[ multiple_benu == 0, ]
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
dt1315_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < ahc_mis*52, 1, 0)]
dt1315_noshare_1bu_nopen <- dt1315_noshare_1bu[ head_pensioner == 0, ]
dt1315_noshare_1bu_nopen <- dt1315_noshare_1bu[ head_pensioner == 0 & is_HRP & (is.na(grossweight) == F), ]
dt1315_noshare_1bu_nopen <- dt1315_noshare_1bu[ head_pensioner == 0 & is_HRP ==1 & (is.na(grossweight) == F), ]
des1315_nosharenopen <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F), ])
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = ".Results/prs_nopen_under_AHC", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = ".Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = ".Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
require(sjPlot)
require(ggplot2)
require(RColorBrewer)
library("reshape2")
require("survey")
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source("./FRS_tools/make_flatfile.R")
##Logical flags for later analysis #
source("./FRS_tools/calculate_logical_flags.R")
## Calculate deflated household incomes
source("./FRS_tools/calculate_household_incomes.R")
source("./FRS_tools/calculate_weights.R")
## Tidy up tenure
source("./FRS_tools/tidy_tenure.R")
## Tidy up regions
source("./FRS_tools/tidy_regions.R")
## Region comparison plotting function
source("./FRS_tools/plot_survey_grpdregion.R")
## Calculate equivalising weights
source("./FRS_tools/calculate_equivalise.R")
## Calculate percentile values for a continuous distribution
source("./FRS_tools/calculate_percentile.R")
## Calculate percentile values for a continuous distribution
source("./FRS_tools/assign_percentile.R")
## Append 2015 MIS amounts
source("./FRS_tools/append_mis.R")
#make plots of household charactersitics
source("./FRS_tools/make_household_plots.R")
#compare charactersitics of JAM groups
source("./FRS_tools/compare_JAM_plots.R")
#compare charactersitics of all LIPR groups
source("./FRS_tools/compare_LIPR_plots.R")
source("./FRS_tools/compare_LIPR_plots_refine.R")
flag.shared.ownership <- function (data_table){
shared_thresh <- read.csv("./shared_ownership_13141415thresholds.csv", header = TRUE,
colClasses = c("double", "double", "double", "character"), stringsAsFactors = FALSE)
shared_thresh <- data.table(shared_thresh)
#return(shared_thresh)
shared_keycols = c("GVTREGN", "year")
shared_cols = c("GVTREGN", "shared", "shared_deposit", "year" )
setkeyv(data_table, shared_keycols)
setkeyv(shared_thresh, shared_keycols)
data_table <- merge(data_table , shared_thresh[ , .SD, .SDcols = shared_cols], by = shared_keycols, all.x = TRUE)
data_table[ , aff_shared_noincben := ifelse( hh_grossinc_noincben >= shared, 1, 0 )]
data_table[ , cant_shareddep := ifelse( (TOTCAPB3 < (shared_deposit - 1000)) & (ADDMON == 2 | behind_debts==1), 1, 0 )]
#flag for shared ownership situation
data_table[ , affanddep_shared := 0]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==1, 1 , 0)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==0, 2 , affanddep_shared)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==0 , 0 , affanddep_shared)]
return(data_table)
}
survey_dir <- "S:/@Communications, Policy and Campaigns/Research/STATS & INFO/Statistics/Household Surveys/"
dt_1415 <- make.flatfile(survey_dir, "1415")
dt_1314 <- make.flatfile(survey_dir, "1314")
dt_1415[ , year := "1415"]
dt_1314[ , year := "1314"]
l <- list(dt_1314, dt_1415)
dt_1315 <- rbindlist(l, fill = TRUE)
rm(l)
dt_1315 <- calculate.logical.flags(dt_1315, "1315")
dt_1315 <- calculate.weights(dt_1315, 1)
dt_1315 <- tidy.tenure(dt_1315)
#Calculate equivalisation weights (according to HBAI spec)
dt_1315<- calculate.equivalise(dt_1315)
#calculate income, including equivalised
dt_1315 <- calculate.household.incomes(dt_1315, "FRS", TRUE)
dt_1315 <- flag.shared.ownership(dt_1315)
dt_1315 <- tidy.regions(dt_1315, "1315")
dt_1315[ , not_1stbenu := ifelse(BENUNIT >1 , 1, 0)]
dt_1315[ , multiple_benu := ifelse( (sum(not_1stbenu) > 0), 1, 0 ), by = .(SERNUM, year) ]
#LIPR definition flags
#more than 20% of household's gross income from benefits (excluding tax credits) - same as Resolution Foundation definition
dt_1315[ , over20gross_allben := ifelse(((HBENINC - HHTXCRED )/(HHINC)) > 0.2, 1, 0)]
#more than 20% of household income-HB comes from non-HB benefits, modified RF definition
dt_1315[ , over20grossnohb_nohbben := ifelse(!is.na(hh_hbweekly),
(ifelse((HBENINC-hh_hbweekly - HHTXCRED)/(HHINC-hh_hbweekly) > 0.2, 1, 0)),
(ifelse((HBENINC- HHTXCRED)/(HHINC) > 0.2, 1, 0)))]
#remove households from sample with shared status and lodgers
dt1315_noshare <- dt_1315[ (has_lodger == 0 & HHSTAT == 1), ]
#select households with only 1 benefit unit - necessary for current shared ownership/MIS definitions of low income
dt1315_noshare_1bu <- dt1315_noshare[ multiple_benu == 0, ]
#Append AHC Minimum Income Standard for households - only works for 1 benefit unit households atm
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
#Add for if AHC income is less than AHC MIS
dt1315_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < ahc_mis*52, 1, 0)]
#Restrict to households not headed by a pensioner
dt1315_noshare_1bu_nopen <- dt1315_noshare_1bu[ head_pensioner == 0 & is_HRP ==1 & (is.na(grossweight) == F), ]
des1315_nosharenopen <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F), ])
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source("./FRS_tools/calculate_percentile.R")
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1314"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1314"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1314", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & aff_shared_noincben ==0 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0 & year == "1415"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_noshared_1415", my_region = "grpd_region1" )
#Characteristics by grouped region for 2013/14
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & aff_shared_noincben ==0  & year == "1314"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0 & year == "1314"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_noshared_1314", my_region = "grpd_region1" )
dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", count(PERSON), by=GVTREGN]
dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", count(PERSON), by=.(GVTREGN)]
dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", n(PERSON), by=.(GVTREGN)]
dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", n(), by=.(GVTREGN)]
dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", .N, by=.(GVTREGN)]
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", .N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_underMIS_1415/subsample_size.csv"))
write.csv( t_samplesize, file = "./Results/prs_nopen_underMIS_1415/subsample_size.csv")
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1314", .N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_underMIS_1314/subsample_size.csv")
View(t_samplesize)
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0 & year == "1415", .N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_noshared_1415/subsample_size.csv")
View(t_samplesize)
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0 & year == "1314", .N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_noshared_1314/subsample_size.csv")
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/lrh_report_analysis.R')
require(sjPlot)
require(ggplot2)
require(RColorBrewer)
library("reshape2")
require("survey")
### Source and define calculating functions ####
## Make flatfiles for each year
source("./FRS_tools/make_flatfile.R")
##Logical flags for later analysis #
source("./FRS_tools/calculate_logical_flags.R")
## Calculate deflated household incomes
source("./FRS_tools/calculate_household_incomes.R")
source("./FRS_tools/calculate_weights.R")
## Tidy up tenure
source("./FRS_tools/tidy_tenure.R")
## Tidy up regions
source("./FRS_tools/tidy_regions.R")
## Region comparison plotting function
source("./FRS_tools/plot_survey_grpdregion.R")
## Calculate equivalising weights
source("./FRS_tools/calculate_equivalise.R")
## Calculate percentile values for a continuous distribution
source("./FRS_tools/calculate_percentile.R")
## Calculate percentile values for a continuous distribution
source("./FRS_tools/assign_percentile.R")
## Append 2015 MIS amounts
source("./FRS_tools/append_mis.R")
#make plots of household charactersitics
source("./FRS_tools/make_household_plots.R")
#compare charactersitics of JAM groups
source("./FRS_tools/compare_JAM_plots.R")
#compare charactersitics of all LIPR groups
source("./FRS_tools/compare_LIPR_plots.R")
source("./FRS_tools/compare_LIPR_plots_refine.R")
flag.shared.ownership <- function (data_table){
shared_thresh <- read.csv("./shared_ownership_13141415thresholds.csv", header = TRUE,
colClasses = c("double", "double", "double", "character"), stringsAsFactors = FALSE)
shared_thresh <- data.table(shared_thresh)
#return(shared_thresh)
shared_keycols = c("GVTREGN", "year")
shared_cols = c("GVTREGN", "shared", "shared_deposit", "year" )
setkeyv(data_table, shared_keycols)
setkeyv(shared_thresh, shared_keycols)
data_table <- merge(data_table , shared_thresh[ , .SD, .SDcols = shared_cols], by = shared_keycols, all.x = TRUE)
data_table[ , aff_shared_noincben := ifelse( hh_grossinc_noincben >= shared, 1, 0 )]
data_table[ , cant_shareddep := ifelse( (TOTCAPB3 < (shared_deposit - 1000)) & (ADDMON == 2 | behind_debts==1), 1, 0 )]
#flag for shared ownership situation
data_table[ , affanddep_shared := 0]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==1, 1 , 0)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==0, 2 , affanddep_shared)]
data_table[ , affanddep_shared := ifelse(aff_shared_noincben==0 , 0 , affanddep_shared)]
return(data_table)
}
### Make flatfiles ####
survey_dir <- "S:/@Communications, Policy and Campaigns/Research/STATS & INFO/Statistics/Household Surveys/"
dt_1415 <- make.flatfile(survey_dir, "1415")
dt_1314 <- make.flatfile(survey_dir, "1314")
dt_1415[ , year := "1415"]
dt_1314[ , year := "1314"]
l <- list(dt_1314, dt_1415)
dt_1315 <- rbindlist(l, fill = TRUE)
rm(l)
#Prep 1315 data set ####
dt_1315 <- calculate.logical.flags(dt_1315, "1315")
dt_1315 <- calculate.weights(dt_1315, 1)
dt_1315 <- tidy.tenure(dt_1315)
#Calculate equivalisation weights (according to HBAI spec)
dt_1315<- calculate.equivalise(dt_1315)
#calculate income, including equivalised
dt_1315 <- calculate.household.incomes(dt_1315, "FRS", TRUE)
dt_1315 <- flag.shared.ownership(dt_1315)
dt_1315 <- tidy.regions(dt_1315, "1315")
dt_1315[ , not_1stbenu := ifelse(BENUNIT >1 , 1, 0)]
dt_1315[ , multiple_benu := ifelse( (sum(not_1stbenu) > 0), 1, 0 ), by = .(SERNUM, year) ]
#LIPR definition flags
#more than 20% of household's gross income from benefits (excluding tax credits) - same as Resolution Foundation definition
dt_1315[ , over20gross_allben := ifelse(((HBENINC - HHTXCRED )/(HHINC)) > 0.2, 1, 0)]
#more than 20% of household income-HB comes from non-HB benefits, modified RF definition
dt_1315[ , over20grossnohb_nohbben := ifelse(!is.na(hh_hbweekly),
(ifelse((HBENINC-hh_hbweekly - HHTXCRED)/(HHINC-hh_hbweekly) > 0.2, 1, 0)),
(ifelse((HBENINC- HHTXCRED)/(HHINC) > 0.2, 1, 0)))]
#remove households from sample with shared status and lodgers
dt1315_noshare <- dt_1315[ (has_lodger == 0 & HHSTAT == 1), ]
#select households with only 1 benefit unit - necessary for current shared ownership/MIS definitions of low income
dt1315_noshare_1bu <- dt1315_noshare[ multiple_benu == 0, ]
#Append AHC Minimum Income Standard for households - only works for 1 benefit unit households atm
dt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, "./MIS_2015.csv")
#Add for if AHC income is less than AHC MIS
dt1315_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < ahc_mis*52, 1, 0)]
#Restrict to households not headed by a pensioner
dt1315_noshare_1bu_nopen <- dt1315_noshare_1bu[ head_pensioner == 0 & is_HRP ==1 & (is.na(grossweight) == F), ]
des1315_nosharenopen <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F), ])
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1415"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1415"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1415", my_region = "grpd_region1" )
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415",
.N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_nosharedbenlim_1415/subsample_size.csv")
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1314"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1
& aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1314"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1314", my_region = "grpd_region1" )
#check sample size
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1314", .N, by=.(GVTREGN)]
write.csv( t_samplesize, file = "./Results/prs_nopen_nosharedbenlim_1314/subsample_size.csv")
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415",
.N, by=.(grpd_region1)]
write.csv( t_samplesize, file = "./Results/prs_nopen_nosharedbenlim_1415/subsample_size_grpdregion1.csv")
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1314", .N, by=.(grpd_region1)]
write.csv( t_samplesize, file = "./Results/prs_nopen_nosharedbenlim_1314/subsample_size_grpdregion1.csv")
svytotal(~(grpd_tenure == 1 & under_ahc_mis == 1), design = subset(des1315_nosharenopen, year == "1415"), na.rm = TRUE)
svymean(~(grpd_tenure == 1 & under_ahc_mis == 1), design = subset(des1315_nosharenopen, year == "1415"), na.rm = TRUE)
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/calculate_percentile.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/calculate_percentile.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415", .N, by=.(grpd_region1)]
write.csv( t_samplesize, file = "./Results/prs_nopen_underMIS_1415/subsample_size_grpdregion1.csv")
t_samplesize <- dt1315_noshare_1bu_nopen[grpd_tenure == 1 & under_ahc_mis == 1 & year == "1314", .N, by=.(grpd_region1)]
write.csv( t_samplesize, file = "./Results/prs_nopen_underMIS_1314/subsample_size_grpdregion1.csv")
my_design <- update(my_design, DVIL04A = factor(DVIL04A))
t_total <- as.data.frame( ftable( svymean(~DVIL04A, des1315_nosharenopen, na.rm = TRUE)))
View(t_total)
my_design <- update(my_design, DVIL04A = factor(DVIL04A))
des1315_nosharenopen <- update(des1315_nosharenopen, DVIL04A = factor(DVIL04A))
t_total <- as.data.frame( ftable( svymean(~DVIL04A, des1315_nosharenopen, na.rm = TRUE)))
svymean(~DVIL04A, des1315_nosharenopen, na.rm = TRUE)
t_total <- as.data.frame(svymean(~DVIL04A, des1315_nosharenopen, na.rm = TRUE))
View(t_total)
t_total <- as.data.frame( ftable( svymean(~DVIL04A, des1315_nosharenopen, na.rm = TRUE)))
View(t_total)
dcast(t_total, Var1 + Var2 ~ Freq)
dcast(t_total, Var2 ~ Freq)
dcast(t_total, Var1 ~ Freq)
dcast(t_total, ~ Freq)
t_total$region <- "England"
View(t_total)
dcast(t_total, region ~ , value.var = "Freq")
dcast(t_total, region ~ Var1 + Var2, value.var = "Freq")
dcast(t_total, region ~ Var2, value.var = "Freq")
dcast(t_total, region + Var1 ~ Var2, value.var = "Freq")
t_total <- dcast(t_total, region + Var1 ~ Var2, value.var = "Freq")
colnames(t_total)[2] <- "Category"
t_total
colnames(t_total)[2] <- "category"
colnames(t_total)[3] <- "svy_fun"
colnames(t_total)[4] <- "SE"
t_total
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/plot_survey_grpdregion.R')
make.household.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & under_ahc_mis == 1 & year == "1415"],
"PRS, no pensioner HRP, under MIS AHC",
results_dir = "./Results/prs_nopen_underMIS_1415", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/make_household_plots.R')
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1415"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1415", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1415"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1 & aff_shared_noincben ==0
& over20grossnohb_nohbben == 0 & year == "1415"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1415", my_region = "grpd_region1" )
make.household.plots(my_design = subset(des1315_nosharenopen,
grpd_tenure == 1 & aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1314"),
my_dt = dt1315_noshare_1bu_nopen[ grpd_tenure == 1
& aff_shared_noincben ==0 & over20grossnohb_nohbben == 0 & year == "1314"],
"PRS, no pensioner HRP, can't afford shared ownership",
results_dir = "./Results/prs_nopen_nosharedbenlim_1314", my_region = "grpd_region1" )
source('S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/FRS_tools/compare_LIPR_plots_refine.R')
