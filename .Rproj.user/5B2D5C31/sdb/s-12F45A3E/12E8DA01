{
    "collab_server" : "",
    "contents" : "########## JAM analysis###########\n### Defining and understanding who is 'Just About Managing' ### \n### Uses Family Resources Survey and Households Below Average Income #####\n### Author: sara_mahmoud@shelter.org.uk####\n\n#set wd to where this is saved\nsetwd(dirname(rstudioapi::getActiveDocumentContext()$path))\n\n#If packages not found, do install.packages(\"foo\") - only necessary first time/if something not working\ninstall.packages(\"devtools\")\nrequire(\"devtools\")\ninstall.packages(\"sqldf\")\n#install.packages(\"data.table\")\ninstall_github(\"Rdatatable/data.table\") #Use dev version on Github\ninstall.packages(\"sjPlot\")\ninstall.packages(\"reshape2\")\ninstall.packages(\"survey\")\n\n#Do this on each re-load\nrequire(sjPlot)\nrequire(ggplot2)\nrequire(RColorBrewer)\nlibrary(\"reshape2\")\nrequire(\"survey\")\n\n\n### Source and define calculating functions ####\n\n## Make flatfiles for each year\nsource(\"./FRS_tools/make_flatfile.R\")\n##Logical flags for later analysis #\nsource(\"./FRS_tools/calculate_logical_flags.R\")\n## Calculate deflated household incomes \nsource(\"./FRS_tools/calculate_household_incomes.R\")\nsource(\"./FRS_tools/calculate_weights.R\")\n## Tidy up tenure \nsource(\"./FRS_tools/tidy_tenure.R\")\n## Tidy up regions \nsource(\"./FRS_tools/tidy_regions.R\")\n## Region comparison plotting function\nsource(\"./FRS_tools/plot_survey_grpdregion.R\")\n## Calculate equivalising weights\nsource(\"./FRS_tools/calculate_equivalise.R\")\n## Calculate percentile values for a continuous distribution\nsource(\"./FRS_tools/calculate_percentile.R\")\n## Calculate percentile values for a continuous distribution\nsource(\"./FRS_tools/assign_percentile.R\")\n## Append 2015 MIS amounts\nsource(\"./FRS_tools/append_mis.R\")\n#make plots of household charactersitics\nsource(\"./FRS_tools/make_household_plots.R\")\n#compare charactersitics of JAM groups\nsource(\"./FRS_tools/compare_JAM_plots.R\")\n#compare charactersitics of all LIPR groups\nsource(\"./FRS_tools/compare_LIPR_plots.R\")\nsource(\"./FRS_tools/compare_LIPR_plots_refine.R\")\n\nflag.shared.ownership <- function (data_table){\n  shared_thresh <- read.csv(\"./shared_onwership_201415thresholds.csv\", stringsAsFactors = FALSE)\n  shared_thresh <- data.table(shared_thresh)\n  \n  shared_keycols = c(\"GVTREGN\")\n  shared_cols = c(\"GVTREGN\", \"shared\", \"shared_deposit\" )\n  \n  setkeyv(data_table, shared_keycols)\n  setkeyv(shared_thresh, shared_keycols)\n  \n  data_table <- merge(data_table , shared_thresh[ , .SD, .SDcols = shared_cols], by = shared_keycols, all.x = TRUE)\n  \n  data_table[ , aff_shared_noincben := ifelse( hh_grossinc_noincben >= shared, 1, 0 )]\n  \n  data_table[ , cant_shareddep := ifelse( (bu_savings < (shared_deposit - 1000)) & (ADDMON == 2 | behind_debts==1), 1, 0 )]\n  \n  #flag for shared ownership situation\n  data_table[ , affanddep_shared := 0]\n  data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==1, 1 , 0)]\n  data_table[ , affanddep_shared := ifelse(aff_shared_noincben==1 & cant_shareddep==0, 2 , affanddep_shared)]\n  data_table[ , affanddep_shared := ifelse(aff_shared_noincben==0 , 0 , affanddep_shared)]\n  \n  \n  return(data_table)\n}\n\n\n### Make flatfiles ####\nsurvey_dir <- \"S:/@Communications, Policy and Campaigns/Research/STATS & INFO/Statistics/Household Surveys/\"\n\ndt_1415 <- make.flatfile(survey_dir, \"1415\")\ndt_1314 <- make.flatfile(survey_dir, \"1314\")\ndt_1415[ , year := \"1415\"]\ndt_1314[ , year := \"1314\"]\n\nl <- list(dt_1314, dt_1415)\ndt_1315 <- rbindlist(l, fill = TRUE)\nrm(l)\n\n#Prep 1415 data set ####\ndt_1415 <- calculate.logical.flags(dt_1415, \"1415\")\ndt_1415 <- calculate.weights(dt_1415, 1)\ndt_1415 <- tidy.tenure(dt_1415)\n#Calculate equivalisation weights (according to HBAI spec)\ndt_1415<- calculate.equivalise(dt_1415)\n#calculate income, including equivalised\ndt_1415 <- calculate.household.incomes(dt_1415, \"FRS\", TRUE)\ndt_1415 <- flag.shared.ownership(dt_1415)\ndt_1415 <- tidy.regions(dt_1415, \"1415\")\n\ndt_1415[ , not_1stbenu := ifelse(BENUNIT >1 , 1, 0)]\ndt_1415[ , multiple_benu := ifelse( (sum(not_1stbenu) > 0), 1, 0 ), by = .(SERNUM, year) ]\n\n\n#remove households from sample with shared status and lodgers\ndt1415_noshare <- dt_1415[ (has_lodger == 0 & HHSTAT == 1), ]\n\n\n#Append AHC Minimum Income Standard for households - only works for 1 benefit unit households atm\n\ndt1415_noshare_1bu <- dt1415_noshare[ multiple_benu == 0, ]\n\ndt1415_noshare_1bu <- append.mis(dt1415_noshare_1bu, \n                                 \"./MIS_2015.csv\")\n\n#Add for if AHC income is less than AHC MIS\ndt1415_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < ahc_mis_15*52, 1, 0)]\n\n\n#Prep 1315 data set ####\ndt_1315 <- calculate.logical.flags(dt_1315, \"1315\")\ndt_1315 <- calculate.weights(dt_1315, 2)\ndt_1315 <- tidy.tenure(dt_1315)\n#Calculate equivalisation weights (according to HBAI spec)\ndt_1315 <- calculate.equivalise(dt_1315)\n#calculate income, including equivalised\ndt_1315 <- calculate.household.incomes(dt_1315, \"FRS\", TRUE)\ndt_1315 <- flag.shared.ownership(dt_1315)\ndt_1315 <- tidy.regions(dt_1315, \"1315\")\n\n#JAM definition flags\n#more than 20% of household's gross income from benefits (excluding tax credits) - same as Resolution Foundation definition\ndt_1315[ , over20gross_allben := ifelse(((HBENINC - HHTXCRED )/(HHINC)) > 0.2, 1, 0)]\n\n#more than 20% of household income-HB comes from non-HB benefits, modified RF definition\ndt_1315[ , over20grossnohb_nohbben := ifelse(!is.na(hh_hbweekly), \n                                             (ifelse((HBENINC-hh_hbweekly - HHTXCRED)/(HHINC-hh_hbweekly) > 0.2, 1, 0)),\n                                              (ifelse((HBENINC- HHTXCRED)/(HHINC) > 0.2, 1, 0)))]\n\ndt_1315[ , not_1stbenu := ifelse(BENUNIT >1 , 1, 0)]\ndt_1315[ , multiple_benu := ifelse( (sum(not_1stbenu) > 0), 1, 0 ), by = .(SERNUM, year) ]\n#remove households from sample with shared status and lodgers\ndt1315_noshare <- dt_1315[ (has_lodger == 0 & HHSTAT == 1), ]\n\n\n#Append AHC Minimum Income Standard for households - only works for 1 benefit unit households atm ####\n\ndt1315_noshare_1bu <- dt1315_noshare[ multiple_benu == 0, ]\n\ndt1315_noshare_1bu <- append.mis(dt1315_noshare_1bu, \"./MIS_2015.csv\")\n\n#Add for if AHC income is less than AHC MIS\ndt1315_noshare_1bu[ , under_ahc_mis := ifelse(hh_gross_ahc < (ahc_mis_15*52), 1, 0)]\n\ndes1315_noshare_1bu <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F), ])\n\n#Look at characteristics of less than AHC MIS ######\n\n\n#proportions, tenure for all under AHC cf no pensioners under AHC\ndes1315_noshare_1bu <- update(des1315_noshare_1bu, under_ahc_mis = factor(under_ahc_mis))\nsvymean(~under_ahc_mis, des1315_noshare_1bu, na.rm=TRUE)\nsvymean(~under_ahc_mis, design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\nsvytotal(~under_ahc_mis, design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\n\nsvymean(~(under_ahc_mis==1 & grpd_tenure == 1), design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\nsvytotal(~(under_ahc_mis==1 & grpd_tenure == 1), design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\n\nsvymean(~under_ahc_mis, design = subset(des1315_noshare_1bu, head_pensioner == 0 & grpd_tenure == 1), na.rm=TRUE)\nsvytotal(~under_ahc_mis, design = subset(des1315_noshare_1bu, head_pensioner == 0 & grpd_tenure == 1), na.rm=TRUE)\n\n\ndes1315_noshare_1bu <- update(des1315_noshare_1bu, grpd_tenure = factor(grpd_tenure, labels = c(\"PRS\", \"Social\", \"Outright\", \"Mortgaged\") ))\nt_tenure_allunderMIS <- as.data.frame(svymean(~grpd_tenure, design = subset(des1315_noshare_1bu, under_ahc_mis ==1), na.rm=TRUE))\nt_tenure_nopenunderMIS <- as.data.frame(svymean(~grpd_tenure, \n                                                design = subset(des1315_noshare_1bu, under_ahc_mis ==1 & head_pensioner == 0), na.rm=TRUE))\n\n\n#get rid of factors to be able to look at prop of pensioners\ndes1315_noshare_1bu <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F), ])\ndes1315_noshare_1bu <- update(des1315_noshare_1bu, head_pensioner = factor(head_pensioner))\nsvymean(~head_pensioner, design= subset(des1315_noshare_1bu, (under_ahc_mis == 1)), na.rm = TRUE )\nsvymean(~head_pensioner, design= subset(des1315_noshare_1bu, (under_ahc_mis == 1 & grpd_tenure == 1)), na.rm = TRUE )\n\n\n# Plots and tables for PRS, no pensioners and under AHC MIS\ndt1315_prsnosharenopen_ahcMIS <- dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F) & grpd_tenure == 1 & \n                                                      head_pensioner == 0 & under_ahc_mis == 1, ]\ndes1315_prsnosharenopen_ahcMIS<- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_prsnosharenopen_ahcMIS)\n\n\n#Region\nt_region_PRSnopen_ahcMIS <-as.data.frame(svymean(~GVTREGN, des1315_prsnosharenopen_ahcMIS, na.rm=TRUE))\nsetDT(t_region_PRSnopen_ahcMIS, keep.rownames = TRUE)[]\n\nggplot(na.omit(t_region_PRSnopen_ahcMIS), aes(x = mean, xmin = mean-SE, xmax = mean+SE, y =rn,\n                                     colour = rn)) +\n  geom_point() + geom_segment( aes(x = mean-SE, xend = mean+SE, y = rn,\n                                   yend=rn)) +\n  #scale_colour_manual(values=c(\"grey19\",\"firebrick3\", \"cyan4\", \"darkorange1\")) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  xlab(\"Prop of households under MIS in region\") + guides(colour=FALSE, shape = FALSE) + ylab(\"Region\")\n\nt_regiontot_PRSnopen_ahcMIS <-as.data.frame(svytotal(~GVTREGN, des1315_prsnosharenopen_ahcMIS, na.rm=TRUE))\n\n#Characteristics by grouped region\nmake.household.plots(des1315_prsnosharenopen_ahcMIS, dt1315_prsnosharenopen_ahcMIS, \"PRS, no pensioner HRP, under MIS AHC\", \n                     results_dir = \"./prs_nopen_under_AHC\", my_region = \"grpd_region1\" )\n\n\n#Renting households who can't afford shared ownership ####\n\n#Prop and total renting households who can't afford shared ownership (no sharers, 1 BU only)\nsvymean(~(aff_shared_noincben == 0 & grpd_tenure == 1), design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\nsvytotal(~(aff_shared_noincben == 0 & grpd_tenure == 1), design = subset(des1315_noshare_1bu, head_pensioner == 0), na.rm=TRUE)\n\nsvymean(~aff_shared_noincben == 0, design = subset(des1315_noshare_1bu, grpd_tenure == 1 &  head_pensioner == 0), na.rm=TRUE)\nsvytotal(~aff_shared_noincben == 0, design = subset(des1315_noshare_1bu, grpd_tenure == 1 &  head_pensioner == 0), na.rm=TRUE)\n\n#Plots and tables for non-pensioner renting households who can't afford shared ownership\ndt1315_prsnosharenopen_sown <- dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F) & grpd_tenure == 1 & \n                                                      head_pensioner == 0 & aff_shared_noincben == 0, ]\ndes1315_prsnosharenopen_sown <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_prsnosharenopen_sown)\n\n#Region\nt_region_PRSnopen_sown <-as.data.frame(svymean(~GVTREGN, des1315_prsnosharenopen_sown, na.rm=TRUE))\nsetDT(t_region_PRSnopen_sown, keep.rownames = TRUE)[]\n\nggplot(na.omit(t_region_PRSnopen_sown), aes(x = mean, xmin = mean-SE, xmax = mean+SE, y =rn,\n                                              colour = rn)) +\n  geom_point() + geom_segment( aes(x = mean-SE, xend = mean+SE, y = rn,\n                                   yend=rn)) +\n  #scale_colour_manual(values=c(\"grey19\",\"firebrick3\", \"cyan4\", \"darkorange1\")) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  xlab(\"Prop of households who can't afford shared ownership in region\") + guides(colour=FALSE, shape = FALSE) + ylab(\"Region\")\n\nt_regiontot_PRSnopen_sown <-as.data.frame(svytotal(~GVTREGN, des1315_prsnosharenopen_sown, na.rm=TRUE))\n\n#Characteristics by grouped region\nmake.household.plots(des1315_prsnosharenopen_sown, dt1315_prsnosharenopen_sown, \"PRS, no pensioner HRP, can't afford shared ownership\", \n                     results_dir = \"./prs_nopen_shared_ownership\", my_region = \"grpd_region1\" )\n\n\n#Overlap between shared ownership and MIS group ####\ndt1315_nosharenopen_1bu <- dt1315_noshare_1bu[is_HRP & (is.na(grossweight) == F) & head_pensioner == 0, ]\n\n\ndt1315_nosharenopen_1bu[ !is.na(aff_shared_noincben) & !is.na(under_ahc_mis), \n                        aff_shared_under_MIS := ifelse(aff_shared_noincben == 0 & under_ahc_mis == 1, 1, 0)]\ndt1315_nosharenopen_1bu[ !is.na(aff_shared_noincben) & !is.na(under_ahc_mis), \n                        aff_shared_under_MIS := ifelse(aff_shared_noincben == 1 & under_ahc_mis == 1, 2, aff_shared_under_MIS)]\ndt1315_nosharenopen_1bu[ !is.na(aff_shared_noincben) & !is.na(under_ahc_mis), \n                        aff_shared_under_MIS := ifelse(aff_shared_noincben == 0 & under_ahc_mis == 0, 3, aff_shared_under_MIS)]\ndt1315_nosharenopen_1bu[ !is.na(aff_shared_noincben) & !is.na(under_ahc_mis), \n                        aff_shared_under_MIS := ifelse(aff_shared_noincben == 1 & under_ahc_mis == 0, 4, aff_shared_under_MIS)]\n\n\ndes1315_prsnosharenopen <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_nosharenopen_1bu[ grpd_tenure == 1 ,])\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, aff_shared_under_MIS = factor(aff_shared_under_MIS, levels = c(1,2,3,4),\n                                                                                         labels = c(\"under MIS and can't own\", \n                                                                                                    \"under MIS and can own\", \n                                                                                                    \"over MIS and can't own\", \n                                                                                                    \"over MIS and can own\") ))\n\nsvymean(~aff_shared_under_MIS, des1315_prsnosharenopen, na.rm = TRUE)\n\n#svymean(~GVTREGN, design = subset(des1315_prsnosharenopen, aff_shared_under_MIS == 2), na.rm = TRUE)\nsvyby(~GVTREGN, by = ~aff_shared_under_MIS, design = des1315_prsnosharenopen, FUN = svymean, na.rm = TRUE)\n\ndt1315_nosharenopen_1bu[ , aff_shared_under_MIS := factor(aff_shared_under_MIS, levels = c(1,2,3,4),\n                                                         labels = c(\"under MIS and can't own\", \n                                                                    \"under MIS and can own\", \n                                                                    \"over MIS and can't own\", \n                                                                    \"over MIS and can own\")) ]\n\n#Plots\nggplot(dt1315_nosharenopen_1bu[grpd_tenure == 1, ], aes(x = hh_grossinc_nohb_eq, weight = grossweight, fill = aff_shared_under_MIS)) +\n  #geom_freqpoly( aes(group = factor(aff_shared_noincben)))\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income - HB: PRS, no pensioner HRP\") +\n  xlim(-100, 75000) + facet_grid( grpd_region1 ~ .)\nggsave(filename = \"./prs_nopen_MISownoverlap/objoverlap_hhgrossinc_nohb_eq.png\")\n\nggplot(dt1315_nosharenopen_1bu[grpd_tenure == 1, ], aes(x = hh_grossinc_nohb, weight = grossweight, fill = aff_shared_under_MIS)) +\n  #geom_freqpoly( aes(group = factor(aff_shared_noincben)))\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross household income - HB: PRS, no pensioner HRP\") +\n  xlim(-100, 75000) + facet_grid( grpd_region1 ~ .)\nggsave(filename = \"./prs_nopen_MISownoverlap/objoverlap_hhgrossinc_nohb.png\")\n\nggplot(dt1315_nosharenopen_1bu[grpd_tenure == 1, ], aes(x = hh_grossinc_noincben_eq, weight = grossweight, fill = aff_shared_under_MIS)) +\n  #geom_freqpoly( aes(group = factor(aff_shared_noincben)))\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income - income related benefits: PRS, no pensioner HRP\") +\n  xlim(-100, 75000) + facet_grid( grpd_region1 ~ .)\nggsave(filename = \"./prs_nopen_MISownoverlap/objoverlap_hhgrossinc_noincben_eq.png\")\n\nggplot(dt1315_nosharenopen_1bu[grpd_tenure == 1, ], aes(x = hh_grossinc_noincben, weight = grossweight, fill = aff_shared_under_MIS)) +\n  #geom_freqpoly( aes(group = factor(aff_shared_noincben)))\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross household income - income related benefits: PRS, no pensioner HRP\") +\n  xlim(-100, 75000) + facet_grid( grpd_region1 ~ .)\nggsave(filename = \"./prs_nopen_MISownoverlap/objoverlap_hhgrossinc_noincben.png\")\n\n\n\n\n## JAM group define: 2-5th percentile of different income distributions, for all non-pension HRP, non-shared households ####\ndt1315_nosharenopen <- dt1315_noshare[head_pensioner == 0, ]\n\n#rank households - 5% percentiles, gross equivalised household income ####\npc5val_hhgreqinc_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_grossinc_eq, \n                                                                 region_form = ~GVTREGN, perc_width = \"5\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc5val_hhgreqinc_nosharenopen, \"hh_grossinc_eq\", perc_width = \"5\")\ncolnames(dt1315_nosharenopen)[281] <- \"pc5position_hhgreqinc_reg\"\ncolnames(dt1315_nosharenopen)[282] <- \"pc5position_hhgreqinc_nat\"\n\n#rank households - 10% percentiles, gross equivalised household income ####\npc10val_hhgreqinc_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_grossinc_eq, \n                                                                 region_form = ~GVTREGN, perc_width = \"10\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc10val_hhgreqinc_nosharenopen, \"hh_grossinc_eq\", perc_width = \"10\")\ncolnames(dt1315_nosharenopen)[283] <- \"pc10position_hhgreqinc_reg\"\ncolnames(dt1315_nosharenopen)[284] <- \"pc10position_hhgreqinc_nat\"\n\n#rank households - 5% percentiles, gross household income -hb, equivalised ####\npc5val_hhgreqinc_nohb_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_grossinc_nohb_eq, \n                                                                 region_form = ~GVTREGN, perc_width = \"5\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc5val_hhgreqinc_nohb_nosharenopen, \"hh_grossinc_nohb_eq\", perc_width = \"5\")\ncolnames(dt1315_nosharenopen)[285] <- \"pc5position_hhgreqincnohb_reg\"\ncolnames(dt1315_nosharenopen)[286] <- \"pc5position_hhgreqincnohb_nat\"\n\n#rank households - 10% percentiles, gross equivalised household income\npc10val_hhgreqinc_nohb_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_grossinc_nohb_eq, \n                                                                  region_form = ~GVTREGN, perc_width = \"10\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc10val_hhgreqinc_nohb_nosharenopen, \"hh_grossinc_nohb_eq\", perc_width = \"10\")\ncolnames(dt1315_nosharenopen)[287] <- \"pc10position_hhgreqincnohb_reg\"\ncolnames(dt1315_nosharenopen)[288] <- \"pc10position_hhgreqincnohb_nat\"\n\n#rank households - 5% percentiles, gross equivalised AHC household income ####\npc5val_hhgreqinc_ahc_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_gross_ahc_eq, \n                                                                 region_form = ~GVTREGN, perc_width = \"5\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc5val_hhgreqinc_ahc_nosharenopen, \"hh_gross_ahc_eq\", perc_width = \"5\")\ncolnames(dt1315_nosharenopen)[289] <- \"pc5position_hhgreqincahc_reg\"\ncolnames(dt1315_nosharenopen)[290] <- \"pc5position_hhgreqincahc_nat\"\n\n#rank households - 10% percentiles, gross equivalised household income\npc10val_hhgreqinc_ahc_nosharenopen <- calculate.percentile.thresholds(DT = dt1315_nosharenopen, distr_var = ~hh_gross_ahc_eq, \n                                                                  region_form = ~GVTREGN, perc_width = \"10\")\ndt1315_nosharenopen <- assign.percentile(dt1315_nosharenopen, pc10val_hhgreqinc_ahc_nosharenopen, \"hh_gross_ahc_eq\", perc_width = \"10\")\ncolnames(dt1315_nosharenopen)[290] <- \"pc10position_hhgreqincahc_reg\"\ncolnames(dt1315_nosharenopen)[291] <- \"pc10position_hhgreqincahc_nat\"\n\n#Create flags for JAM definition groups ####\ndt1315_nosharenopen[ , JAMbase_greqinc := ifelse(pc10position_hhgreqinc_nat >= 2 & pc10position_hhgreqinc_nat <= 5, 1, 0 )]\ndt1315_nosharenopen[ , JAMrf_greqinc := ifelse((pc10position_hhgreqinc_nat >= 2 & pc10position_hhgreqinc_nat <= 5) \n                                               & over20gross_allben == 0, 1, 0 )]\ndt1315_nosharenopen[ , JAMnohb_greqinc := ifelse((pc10position_hhgreqincnohb_nat >= 2 & pc10position_hhgreqincnohb_nat <= 5), 1, 0 )]\ndt1315_nosharenopen[ , JAMnohbrf_greqinc := ifelse((pc10position_hhgreqincnohb_nat >= 2 & pc10position_hhgreqincnohb_nat <= 5) \n                                                      & over20grossnohb_nohbben == 0, 1, 0 )]\n\ndt1315_nosharenopen[ , JAMnohbwork_greqinc := ifelse((pc10position_hhgreqincnohb_nat >= 2 & pc10position_hhgreqincnohb_nat <= 5) \n                                                   & hrp_nowork == FALSE, 1, 0 )]\n\ndt1315_nosharenopen[ , JAMbase_ahc := ifelse((pc10position_hhgreqincahc_nat >= 2 & pc10position_hhgreqincahc_nat <= 5), 1, 0 )]\ndt1315_nosharenopen[ , JAMwork_ahc := ifelse((pc10position_hhgreqincahc_nat >= 2 & pc10position_hhgreqincahc_nat <= 5) \n                                                    & hrp_nowork == FALSE, 1, 0 )]\n\n\n# Plot JAM groups in gross equivalised income distribution ####\ndt1315_nosharenopen[ , JAMbase_greqinc := factor(JAMbase_greqinc)]\nggplot(dt1315_nosharenopen[!is.na(JAMbase_greqinc) & is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMbase_greqinc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMbase_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMrf_greqinc := factor(JAMrf_greqinc)]\nggplot(dt1315_nosharenopen[!is.na(JAMrf_greqinc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMrf_greqinc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMrf_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMnohb_greqinc := factor(JAMnohb_greqinc)]\nggplot(dt1315_nosharenopen[!is.na(JAMnohb_greqinc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMnohb_greqinc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMnohb_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMnohbrf_greqinc := factor(JAMnohbrf_greqinc)]\nggplot(dt1315_nosharenopen[!is.na(JAMnohbrf_greqinc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMnohbrf_greqinc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMnohbrf_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMnohbrf_prs := ifelse(JAMnohbrf_greqinc ==1 & grpd_tenure == 1, 1, 0)]\ndt1315_nosharenopen[ , JAMnohbrf_prs := factor(JAMnohbrf_prs)]\nggplot(dt1315_nosharenopen[!is.na(JAMnohbrf_prs)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMnohbrf_prs, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMnohbrfprs_hhgrossinceq.png\")\n\n\ndt1315_nosharenopen[ , JAMnohbwork_greqinc := factor(JAMnohbwork_greqinc)]\nggplot(dt1315_nosharenopen[!is.na(JAMnohbwork_greqinc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMnohbwork_greqinc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMnohbwork_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMbase_ahc := factor(JAMbase_ahc)]\nggplot(dt1315_nosharenopen[!is.na(JAMbase_ahc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMbase_ahc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMbaseahc_hhgrossinceq.png\")\n\ndt1315_nosharenopen[ , JAMwork_ahc := factor(JAMwork_ahc)]\nggplot(dt1315_nosharenopen[!is.na(JAMwork_ahc)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMwork_ahc, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMworkahc_hhgrossinceq.png\")\n\n\n#Make tables of hhld characteristics for each definition ####\n#merge in under_ahc_mis definition\nkeycols = c(\"SERNUM\",\"BENUNIT\",\"PERSON\", \"year\")\nsetkeyv(dt1315_nosharenopen, keycols)\nsetkeyv(dt1315_noshare_1bu, keycols)\ndt1315_nosharenopen <- merge(dt1315_nosharenopen, dt1315_noshare_1bu[, .SD, .SDcols = c(\"SERNUM\",\"BENUNIT\",\"PERSON\", \"year\", \n                                                                                        \"under_ahc_mis\")], \n                             by = keycols, all.x = TRUE)\n\ndt1315_nosharenopen[ , under_MIS_prs := ifelse(under_ahc_mis == 1 & grpd_tenure == 1, 1, 0)]\n\ndes1315_nosharenopen <- svydesign(ids = ~1, weights = ~grossweight, data = dt1315_nosharenopen[is_HRP & (is.na(grossweight) == F),])\n\n\n#Proportion of non-pen households in each JAM group ####\ndes1315_nosharenopen <- update(des1315_nosharenopen, JAMbase_greqinc = factor(JAMbase_greqinc ==1))\nt_prop_JAMbase_greq <- as.data.frame(svymean(~JAMbase_greqinc, des1315_nosharenopen, na.rm=TRUE))\nsetDT(t_prop_JAMbase_greq, keep.rownames = TRUE)[]\nt_prop_JAMbase_greq<- t_prop_JAMbase_greq[2,] \ncolnames(t_prop_JAMbase_greq)[1] <- \"definition\"\nt_prop_JAMbase_greq$definition <- \"JAM baseline\"\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, grpd_tenure = factor(JAMrf_greqinc ==1))\nt_prop_JAMrf_greq <- as.data.frame(svymean(~JAMrf_greqinc, des1315_nosharenopen, na.rm=TRUE))\nsetDT(t_prop_JAMrf_greq, keep.rownames = TRUE)[]\nt_prop_JAMrf_greq<- t_prop_JAMrf_greq[2,] \ncolnames(t_prop_JAMrf_greq)[1] <- \"definition\"\nt_prop_JAMrf_greq$definition <- \"JAM RF\"\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, grpd_tenure = factor(JAMnohb_greqinc ==1))\nt_prop_JAMnohb_greq <- as.data.frame(svymean(~JAMnohb_greqinc, des1315_nosharenopen, na.rm=TRUE))\nsetDT(t_prop_JAMnohb_greq, keep.rownames = TRUE)[]\nt_prop_JAMnohb_greq<- t_prop_JAMnohb_greq[2,] \ncolnames(t_prop_JAMnohb_greq)[1] <- \"definition\"\nt_prop_JAMnohb_greq$definition <- \"JAM no HB\"\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, grpd_tenure = factor(JAMnohbrf_greqinc ==1))\nt_prop_JAMnohbrf_greq <- as.data.frame(svymean(~JAMnohbrf_greqinc, des1315_nosharenopen, na.rm=TRUE))\nsetDT(t_prop_JAMnohbrf_greq, keep.rownames = TRUE)[]\nt_prop_JAMnohbrf_greq<- t_prop_JAMnohbrf_greq[2,] \ncolnames(t_prop_JAMnohbrf_greq)[1] <- \"definition\"\nt_prop_JAMnohbrf_greq$definition <- \"JAM no HB RF\"\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, grpd_tenure = factor(JAMnohbwork_greqinc ==1))\nt_prop_JAMnohbwork_greq <- as.data.frame(svymean(~JAMnohbwork_greqinc, des1315_nosharenopen, na.rm=TRUE))\nsetDT(t_prop_JAMnohbwork_greq, keep.rownames = TRUE)[]\nt_prop_JAMnohbwork_greq<- t_prop_JAMnohbwork_greq[2,] \ncolnames(t_prop_JAMnohbwork_greq)[1] <- \"definition\"\nt_prop_JAMnohbwork_greq$definition <- \"JAM no HB working\"\n\nprop_list <- list(t_prop_JAMbase_greq, t_prop_JAMrf_greq, t_prop_JAMnohbrf_greq, t_prop_JAMnohb_greq, t_prop_JAMnohbwork_greq )\nt_prop_JAM<- rbindlist(prop_list, fill = TRUE) \nrm(prop_list)\nrm(t_prop_JAMbase_greq, t_prop_JAMrf_greq, t_prop_JAMnohbrf_greq, t_prop_JAMnohb_greq, t_prop_JAMnohbwork_greq)\n\nggplot(na.omit(t_prop_JAM), aes(x = mean, xmin = mean-SE, xmax = mean+SE, y =definition,\n                                     colour = definition)) +\n  geom_point() + geom_segment( aes(x = mean-SE, xend = mean+SE, y = definition,\n                                   yend=definition)) +\n  #scale_colour_manual(values=c(\"grey19\",\"firebrick3\", \"cyan4\", \"darkorange1\")) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  xlab(\"Prop of non-pensioner HRP households\") + guides(colour=FALSE, shape = FALSE) + ylab(\"JAM definition\")+\n  ggtitle(\"Prop all non-pensioner HRP households in different JAM definitions\")\nggsave(filename = \"./nopen_JAMdefs/JAMdefs_propcompare.png\")\n\nwrite.csv(t_prop_JAM, file = \"./nopen_JAMdefs/JAMdefs_propcompare.csv\")\n\n\n\n#Prop of each group under AHC MIS private renters #### \ndes1315_nosharenopen <- update(des1315_nosharenopen, under_MIS_prs = factor(under_MIS_prs))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"under_MIS_prs\", \n                  p_title = \"Prop of JAM who are private renters under MIS - no pensioner HRP\", plot_mode = \"proportion\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_shared_prs = ifelse(aff_shared_noincben == 0 & grpd_tenure == 1, 1, 0 ))\n#Above should be done in the dataset, not in survey design\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_shared_prs = factor(no_shared_prs))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"no_shared_prs\", \n                  p_title = \"Prop of JAM who are private renters and can't afford shared ownership - no pensioner HRP\", plot_mode = \"proportion\")\n\ncompare.JAM.plots(my_design = subset(des1315_nosharenopen, grpd_tenure == 1), results_dir = \"./nopen_JAMdefs/\", variable = \"under_MIS_prs\", \n                  p_title = \"Prop of private renting JAM who are private renters under MIS - no pensioner HRP\", plot_mode = \"proportion\")\n\n\n#Characteristics by JAM group ####\ndes1315_nosharenopen <- update(des1315_nosharenopen, grpd_tenure = factor(grpd_tenure ))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"grpd_tenure\", \n                  var_levels = c(\"grpd_tenure1\", \"grpd_tenure2\", \"grpd_tenure3\", \"grpd_tenure4\"),\n                  var_labels = c(\"PRS\", \"Social\", \"Outright\", \"Mortgaged\"),\n                  p_title = \"Tenure by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_shared_prs = ifelse(aff_shared_noincben == 0 & grpd_tenure == 1, 1, 0 ))\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_shared_prs = factor(no_shared_prs))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"no_shared_prs\", \n                  var_levels = c(\"no_shared_prs0\", \"no_shared_prs1\"),\n                  var_labels = c(\"Can afford\", \"Can't afford\"),\n                  p_title = \"Can afford shared ownership and PRS by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\nsvytotal(~grpd_tenure, design = subset(des1315_nosharenopen, JAMbase_greqinc ==1), na.rm=TRUE)\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, GVTREGN = factor(GVTREGN ))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"GVTREGN\", \n                  var_levels = c(\"GVTREGNNorth East\", \"GVTREGNNorth West\", \"GVTREGNYorks & Humber\", \"GVTREGNEast Midlands\", \n                                 \"GVTREGNWest Midlands\", \"GVTREGNEast\", \"GVTREGNLondon\", \"GVTREGNSouth East\", \"GVTREGNSouth West\"),\n                  var_labels = c(\"North East\", \"North West\", \"Yorks & Humber\", \"East Midlands\", \n                                 \"West Midlands\", \"East\", \"London\", \"South East\", \"South West\"),\n                  p_title = \"Region by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, HDAGE = factor(HDAGE))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"HDAGE\", \n                  var_levels = c(\"HDAGE1\", \"HDAGE2\", \"HDAGE3\", \"HDAGE4\", \"HDAGE5\", \"HDAGE6\"),\n                  var_labels = c(\"16 to 24\", \"25 to 34\", \"35 to 44\", \"45 to 54\", \"55 to 64\", \"65+\"),\n                  p_title = \"Age by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, DVIL04A = factor(DVIL04A))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"DVIL04A\", \n                  var_levels = c(\"DVIL04A1\", \"DVIL04A2\", \"DVIL04A3\", \"DVIL04A4\"),\n                  var_labels = c(\"Employed\", \"Family worker\", \"Unemployed\", \"Inactive\"), \n                  p_title = \"HRP employment (ILO) by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, ECOBU = factor(ECOBU))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"ECOBU\", \n                  var_levels = c(\"ECOBU1\", \"ECOBU2\", \"ECOBU3\", \"ECOBU4\", \"ECOBU5\", \"ECOBU6\", \"ECOBU7\", \"ECOBU8\"),\n                  var_labels = c(\"1+ self employed\", \"Sing/couple all FT\", \n                                 \"Couple, 1 FT, 1 PT\",  \"Couple, 1 FT, 1 not working\", \n                                 \"No FT, 1+ PT\", \"Workless, head/spouse aged 60+\", \n                                 \"Workless, head/spouse unemployed\", \"Workless, inactive\" ),\n                  p_title = \"Employment of household by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, SELFDEMP = factor(SELFDEMP))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"SELFDEMP\", \n                  var_levels = c(\"SELFDEMP1\", \"SELFDEMP2\", \"SELFDEMP3\", \"SELFDEMP4\", \"SELFDEMP5\",\"SELFDEMP6\", \"SELFDEMP7\",\n                                 \"SELFDEMP8\", \"SELFDEMP9\", \"SELFDEMP10\"),\n                  var_labels = c(\"Full-time\", \"Part-time\", \"FT self-employed\", \"PT self-employed\",\n                                 \"Unemployed\", \"Student\", \"Family home\", \"Disabled\", \"Retired\", \"Other\"),\n                  p_title = \"Self-reported HRP situation by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_kids16 = factor(has_kids16))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"has_kids16\", \n                  var_levels = c(\"has_kids160\", \"has_kids161\"),\n                  var_labels = c(\"No school age kids\", \"Has school age kids\"), \n                  p_title = \"Has children by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, single_parent = factor(single_parent))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"single_parent\", \n                  var_levels = c(\"single_parent0\", \"single_parent1\"),\n                  var_labels = c(\"Not Single parent head\", \"Single parent head \"),\n                  p_title = \"Is single parent by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_disabled = ifelse((has_disabledad ==1 | has_disabledch == 1), 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_disabled = factor(has_disabled))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"has_disabled\", \n                  var_levels = c(\"has_disabled0\", \"has_disabled1\"),\n                  var_labels = c(\"No disabled\", \"Has disabled person\"), \n                  p_title = \"Has disabled adult or child by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_savings = ifelse(TOTCAPB3==0, 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_savings = factor(no_savings))\ncompare.JAM.plots(my_design = des1315_nosharenopen, results_dir = \"./nopen_JAMdefs/\", variable = \"no_savings\", \n                  var_levels = c(\"no_savings0\", \"no_savings1\"),\n                  var_labels = c(\"No savings\", \"Has savings\"), \n                  p_title = \"Has savings by JAM definition - no pensioner HRP\", plot_mode = \"var_compare\")\n\n\n# Characteristics of renting households by LIPR definition####\ndes1315_prsnosharenopen <- subset(des1315_nosharenopen, grpd_tenure == 1)\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, GVTREGN = factor(GVTREGN ))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"GVTREGN\", \n                  var_levels = c(\"GVTREGNNorth East\", \"GVTREGNNorth West\", \"GVTREGNYorks & Humber\", \"GVTREGNEast Midlands\", \n                                 \"GVTREGNWest Midlands\", \"GVTREGNEast\", \"GVTREGNLondon\", \"GVTREGNSouth East\", \"GVTREGNSouth West\"),\n                  var_labels = c(\"North East\", \"North West\", \"Yorks & Humber\", \"East Midlands\", \n                                 \"West Midlands\", \"East\", \"London\", \"South East\", \"South West\"),\n                  p_title = \"Region by LIPR definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, HDAGE = factor(HDAGE))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"HDAGE\", \n                  var_levels = c(\"HDAGE1\", \"HDAGE2\", \"HDAGE3\", \"HDAGE4\", \"HDAGE5\", \"HDAGE6\"),\n                  var_labels = c(\"16 to 24\", \"25 to 34\", \"35 to 44\", \"45 to 54\", \"55 to 64\", \"65+\"),\n                  p_title = \"Age by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, DVIL04A = factor(DVIL04A))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"DVIL04A\", \n                  var_levels = c(\"DVIL04A1\", \"DVIL04A2\", \"DVIL04A3\", \"DVIL04A4\"),\n                  var_labels = c(\"Employed\", \"Family worker\", \"Unemployed\", \"Inactive\"), \n                  p_title = \"HRP employment (ILO) by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, ECOBU = factor(ECOBU))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"ECOBU\", \n                  var_levels = c(\"ECOBU1\", \"ECOBU2\", \"ECOBU3\", \"ECOBU4\", \"ECOBU5\", \"ECOBU6\", \"ECOBU7\", \"ECOBU8\"),\n                  var_labels = c(\"1+ self employed\", \"Sing/couple all FT\", \n                                 \"Couple, 1 FT, 1 PT\",  \"Couple, 1 FT, 1 not working\", \n                                 \"No FT, 1+ PT\", \"Workless, head/spouse aged 60+\", \n                                 \"Workless, head/spouse unemployed\", \"Workless, inactive\" ),\n                  p_title = \"Employment of household by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, SELFDEMP = factor(SELFDEMP))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"SELFDEMP\", \n                  var_levels = c(\"SELFDEMP1\", \"SELFDEMP2\", \"SELFDEMP3\", \"SELFDEMP4\", \"SELFDEMP5\",\"SELFDEMP6\", \"SELFDEMP7\",\n                                 \"SELFDEMP8\", \"SELFDEMP9\", \"SELFDEMP10\"),\n                  var_labels = c(\"Full-time\", \"Part-time\", \"FT self-employed\", \"PT self-employed\",\n                                 \"Unemployed\", \"Student\", \"Family home\", \"Disabled\", \"Retired\", \"Other\"),\n                  p_title = \"Self-reported HRP situation by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, has_kids16 = factor(has_kids16))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"has_kids16\", \n                  var_levels = c(\"has_kids160\", \"has_kids161\"),\n                  var_labels = c(\"No school age kids\", \"Has school age kids\"), \n                  p_title = \"Has children by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, single_parent = factor(single_parent))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"single_parent\", \n                  var_levels = c(\"single_parent0\", \"single_parent1\"),\n                  var_labels = c(\"Not Single parent head\", \"Single parent head \"),\n                  p_title = \"Is single parent by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, has_disabled = ifelse((has_disabledad ==1 | has_disabledch == 1), 1, 0))\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, has_disabled = factor(has_disabled))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"has_disabled\", \n                  var_levels = c(\"has_disabled0\", \"has_disabled1\"),\n                  var_labels = c(\"No disabled\", \"Has disabled person\"), \n                  p_title = \"Has disabled adult or child by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, no_savings = ifelse(TOTCAPB3==0, 1, 0))\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, no_savings = factor(no_savings))\ncompare.LIPR.plots(my_design = des1315_prsnosharenopen, results_dir = \"./prs_nopen_comparedefs/\", variable = \"no_savings\", \n                  var_levels = c(\"no_savings0\", \"no_savings1\"),\n                  var_labels = c(\"No savings\", \"Has savings\"), \n                  p_title = \"Has savings by JAM definition - PRS no pensioner HRP\", plot_mode = \"var_compare\")\n\ndt1315_nosharenopen[ , JAMnohbrf_MIC_overlap := ifelse(JAMnohbrf_greqinc ==1 & grpd_tenure == 1 & under_ahc_mis ==1, 1, 0)]\ndt1315_nosharenopen[ , JAMnohbrf_MIC_overlap := factor(JAMnohbrf_MIC_overlap)]\nggplot(dt1315_nosharenopen[!is.na(JAMnohbrf_MIC_overlap)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = JAMnohbrf_MIC_overlap, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/JAMnohbrf_MIC_overlap_hhgrossinceq.png\")\n\n\ndt1315_nosharenopen[ , under_MIS_prs := factor(under_MIS_prs)]\nggplot(dt1315_nosharenopen[!is.na(under_MIS_prs)& is_HRP==1,], aes(x = hh_grossinc_eq, fill = under_MIS_prs, weight = grossweight) ) +\n  geom_histogram(binwidth = 1000) +\n  theme( legend.position = \"top\", panel.background = element_rect(fill = \"white\"),\n         panel.grid.major = element_line(colour = \"grey85\")) +\n  ggtitle(\"Gross equivalised household income: no pensioner HRP\") +\n  xlim(-100, 100000)\nggsave(filename = \"./nopen_JAMdefs/under_MIS_prs_hhgrossinceq.png\")\n\n\n#More LIPR compare plots, this time cf to all working age households ####\ndes1315_nosharenopen <- update(des1315_nosharenopen, GVTREGN = factor(GVTREGN ))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"GVTREGN\", \n                   var_levels = c(\"GVTREGNNorth East\", \"GVTREGNNorth West\", \"GVTREGNYorks & Humber\", \"GVTREGNEast Midlands\", \n                                  \"GVTREGNWest Midlands\", \"GVTREGNEast\", \"GVTREGNLondon\", \"GVTREGNSouth East\", \"GVTREGNSouth West\"),\n                   var_labels = c(\"North East\", \"North West\", \"Yorks & Humber\", \"East Midlands\", \n                                  \"West Midlands\", \"East\", \"London\", \"South East\", \"South West\"),\n                   p_title = \"Region - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, HDAGE = factor(HDAGE))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"HDAGE\", \n                   var_levels = c(\"HDAGE1\", \"HDAGE2\", \"HDAGE3\", \"HDAGE4\", \"HDAGE5\", \"HDAGE6\"),\n                   var_labels = c(\"16 to 24\", \"25 to 34\", \"35 to 44\", \"45 to 54\", \"55 to 64\", \"65+\"),\n                   p_title = \"Age - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, DVIL04A = factor(DVIL04A))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"DVIL04A\", \n                   var_levels = c(\"DVIL04A1\", \"DVIL04A2\", \"DVIL04A3\", \"DVIL04A4\"),\n                   var_labels = c(\"Employed\", \"Family worker\", \"Unemployed\", \"Inactive\"), \n                   p_title = \"HRP employment (ILO) - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, ECOBU = factor(ECOBU))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"ECOBU\", \n                   var_levels = c(\"ECOBU1\", \"ECOBU2\", \"ECOBU3\", \"ECOBU4\", \"ECOBU5\", \"ECOBU6\", \"ECOBU7\", \"ECOBU8\"),\n                   var_labels = c(\"1+ self employed\", \"Sing/couple all FT\", \n                                  \"Couple, 1 FT, 1 PT\",  \"Couple, 1 FT, 1 not working\", \n                                  \"No FT, 1+ PT\", \"Workless, head/spouse aged 60+\", \n                                  \"Workless, head/spouse unemployed\", \"Workless, inactive\" ),\n                   p_title = \"Employment of household - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, SELFDEMP = factor(SELFDEMP))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"SELFDEMP\", \n                   var_levels = c(\"SELFDEMP1\", \"SELFDEMP2\", \"SELFDEMP3\", \"SELFDEMP4\", \"SELFDEMP5\",\"SELFDEMP6\", \"SELFDEMP7\",\n                                  \"SELFDEMP8\", \"SELFDEMP9\", \"SELFDEMP10\"),\n                   var_labels = c(\"Full-time\", \"Part-time\", \"FT self-employed\", \"PT self-employed\",\n                                  \"Unemployed\", \"Student\", \"Family home\", \"Disabled\", \"Retired\", \"Other\"),\n                   p_title = \"Self-reported HRP situation - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_kids16 = factor(has_kids16))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"has_kids16\", \n                   var_levels = c(\"has_kids160\", \"has_kids161\"),\n                   var_labels = c(\"No school age kids\", \"Has school age kids\"), \n                   p_title = \"Has children - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, single_parent = factor(single_parent))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"single_parent\", \n                   var_levels = c(\"single_parent0\", \"single_parent1\"),\n                   var_labels = c(\"Not Single parent head\", \"Single parent head \"),\n                   p_title = \"Is single parent - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_disabled = ifelse((has_disabledad ==1 | has_disabledch == 1), 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, has_disabled = factor(has_disabled))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"has_disabled\", \n                   var_levels = c(\"has_disabled0\", \"has_disabled1\"),\n                   var_labels = c(\"No disabled\", \"Has disabled person\"), \n                   p_title = \"Has disabled adult or child - no pensioner HRP\", plot_mode = \"var_compare\")\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_savings = ifelse(TOTCAPB3==0, 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, no_savings = factor(no_savings))\ncompare.LIPR.plots.refine(my_design = des1315_nosharenopen, results_dir = \"./nopen_comparedefs/\", variable = \"no_savings\", \n                   var_levels = c(\"no_savings0\", \"no_savings1\"),\n                   var_labels = c(\"No savings\", \"Has savings\"), \n                   p_title = \"Has savings - no pensioner HRP\", plot_mode = \"var_compare\")\n\n### what % of obj group is in each def? ####\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMbase_greqinc = factor(JAMbase_greqinc))\nsvymean(~JAMbase_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMrf_greqinc = factor(JAMrf_greqinc))\nsvymean(~JAMrf_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMnohb_greqinc = factor(JAMnohb_greqinc))\nsvymean(~JAMnohb_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMnohbwork_greqinc = factor(JAMnohbwork_greqinc))\nsvymean(~JAMnohbwork_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMnohbrf_greqinc = factor(JAMnohbrf_greqinc))\nsvymean(~JAMnohbrf_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\ndes1315_prsnosharenopen <- update(des1315_prsnosharenopen, JAMbase_greqinc = factor(JAMbase_greqinc))\nsvymean(~JAMbase_greqinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1), na.rm = TRUE)\n\n\nsvymean(~JAMbase_greqinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), na.rm = TRUE)\nsvymean(~JAMrf_greqinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), na.rm = TRUE)\nsvymean(~JAMnohb_greqinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), na.rm = TRUE)\nsvymean(~JAMnohbwork_greqinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), na.rm = TRUE)\nsvymean(~JAMnohbrf_greqinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), na.rm = TRUE)\n\n\n\n#% of working age households fitting JAM defs & PRS ####\nsvytotal(~JAMrf_greqinc, des1315_nosharenopen, na.rm = TRUE)\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, JAMbase_prs = ifelse(JAMbase_greqinc == 1 & grpd_tenure ==1, 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, JAMbase_prs = factor(JAMbase_prs))\nsvymean(~JAMbase_prs, des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~JAMbase_prs, des1315_nosharenopen, na.rm = TRUE)\n\ndes1315_nosharenopen <- update(des1315_nosharenopen, JAMnohbrf_prs = ifelse(JAMnohbrf_greqinc == 1 & grpd_tenure ==1, 1, 0))\ndes1315_nosharenopen <- update(des1315_nosharenopen, JAMnohbrf_prs = factor(JAMnohbrf_prs))\nsvymean(~JAMnohbrf_prs, des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~JAMnohbrf_prs, des1315_nosharenopen, na.rm = TRUE)\n\nsvyquantile(~hh_grossinc, design = subset(des1315_prsnosharenopen, aff_shared_noincben == 0), quantiles = 0.5, na.rm=TRUE)\nsvyquantile(~hh_grossinc, design = subset(des1315_prsnosharenopen, under_ahc_mis == 1 ), quantiles = 0.5, na.rm=TRUE)\nsvyquantile(~hh_grossinc, design = subset(des1315_prsnosharenopen, JAMbase_greqinc == 1 ), quantiles = 0.5, na.rm=TRUE)\nsvyquantile(~hh_grossinc, design = subset(des1315_prsnosharenopen, JAMnohbrf_greqinc == 1 ), quantiles = 0.5, na.rm=TRUE)\n\n# Overlap group - JAM + objective def, proportion of working age\nsvymean(~(JAMbase_prs & under_MIS_prs), des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~(JAMbase_prs & under_MIS_prs), des1315_nosharenopen, na.rm = TRUE)\n\nsvymean(~(JAMnohbrf_prs & under_MIS_prs), des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~(JAMnohbrf_prs & under_MIS_prs), des1315_nosharenopen, na.rm = TRUE)\n\nsvyquantile(~hh_grossinc, design = subset(des1315_nosharenopen, JAMnohbrf_prs ==1 &under_ahc_mis == 1 ), quantiles = 0.5, na.rm=TRUE)\n\nsvymean(~(JAMbase_prs & no_shared_prs), des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~(JAMbase_prs & no_shared_prs), des1315_nosharenopen, na.rm = TRUE)\n\nsvymean(~(JAMnohbrf_prs & no_shared_prs), des1315_nosharenopen, na.rm = TRUE)\nsvytotal(~(JAMnohbrf_prs & no_shared_prs), des1315_nosharenopen, na.rm = TRUE)\n\n#overlap plots\ndes1315_nosharenopen <- update(des1315_nosharenopen, shared_JAM = ifelse(aff_shared_noincben == 0 & JAMnohbrf_greqinc == 1, 1, 0))\n\n\n# proportion of objective definition captured by JAM\n\nsvymean(~(JAMbase_prs), design = subset(des1315_nosharenopen, under_MIS_prs == 1), na.rm = TRUE)\nsvymean(~(JAMrf_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, under_MIS_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohb_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, under_MIS_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohbwork_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, under_MIS_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohbrf_prs), design = subset(des1315_nosharenopen, under_MIS_prs == 1), na.rm = TRUE)\n\nsvymean(~(JAMbase_prs), design = subset(des1315_nosharenopen, no_shared_prs == 1), na.rm = TRUE)\nsvymean(~(JAMrf_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, no_shared_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohb_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, no_shared_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohbwork_greqinc == 1 & grpd_tenure == 1), design = subset(des1315_nosharenopen, no_shared_prs == 1), na.rm = TRUE)\nsvymean(~(JAMnohbrf_prs), design = subset(des1315_nosharenopen, no_shared_prs == 1), na.rm = TRUE)\n\n\n\n#prop multiple benu\nftable(svyby(formula = ~factor(multiple_benu), by = ~GVTREGN, design = desall_1415, FUN = svymean, na.rm = TRUE))\ndesall_1415 <- update(desall_1415, BENUNITS = factor(BENUNITS))\nftable(svyby(formula = ~BENUNITS, by = ~GVTREGN, design = desall_1415, FUN = svymean, na.rm = TRUE))\n\n\n",
    "created" : 1490368741716.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3226424206",
    "id" : "12E8DA01",
    "lastKnownWriteTime" : 1490030349,
    "last_content_update" : 1490030349,
    "path" : "S:/@Communications, Policy and Campaigns/Research/RESEARCH/More Affordable Homes/Future of low rent homes/low_rent_homes_report/JAM_analysis.R",
    "project_path" : "JAM_analysis.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}